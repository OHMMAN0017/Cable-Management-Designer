<script>
const cableData = {
    iec01: { "1.5": 8.5, "2.5": 12.5, "4": 16.6, "6": 21.2, "10": 35.2, "16": 47.7, "25": 73.8, "35": 93.9, "50": 129 },
    nyy1c: { "1": 60.8, "1.5": 66.5, "2.5": 75.4, "4": 86.6, "6": 95, "10": 113, "16": 133 },
    xlpe1c: { "1.5": 33.1, "2.5": 38.4, "4": 44.1, "6": 50.2, "10": 56.7, "16": 70.8 }
};

const conduitData = [
    { name: '1/2"', area40: 71, price: 145 },
    { name: '3/4"', area40: 126, price: 195 },
    { name: '1"', area40: 196, price: 290 },
    { name: '1 1/4"', area40: 322, price: 420 },
    { name: '1 1/2"', area40: 503, price: 550 },
    { name: '2"', area40: 785, price: 780 }
];

const wirewayData = [
    { name: "50x75", area20: 750, price: 380 },
    { name: "50x100", area20: 1000, price: 450 },
    { name: "75x100", area20: 1500, price: 580 },
    { name: "100x100", area20: 2000, price: 720 }
];

function updateSizes() {
    const type = document.getElementById('cableType').value;
    const sizeSelect = document.getElementById('cableSize');
    sizeSelect.innerHTML = '';

    Object.keys(cableData[type]).forEach(size => {
        let opt = document.createElement('option');
        opt.value = size;
        opt.innerHTML = size;
        sizeSelect.appendChild(opt);
    });
}

document.getElementById('cableType').addEventListener("change", updateSizes);
updateSizes();

function calculate() {
    const type = document.getElementById('cableType').value;
    const size = document.getElementById('cableSize').value;
    const qty = parseInt(document.getElementById('cableQty').value);

    if (!qty || qty <= 0) {
        alert("กรุณาใส่จำนวนสายให้ถูกต้อง");
        return;
    }

    const installType = document.querySelector('input[name="installType"]:checked').value;

    const totalCableArea = cableData[type][size] * qty;
    const masterList = installType === 'conduit' ? conduitData : wirewayData;
    const limitField = installType === 'conduit' ? 'area40' : 'area20';

    // เรียงจากเล็กไปใหญ่ก่อน
    const sortedList = masterList.sort((a, b) => a[limitField] - b[limitField]);

    const possibleOptions = sortedList.filter(item => item[limitField] >= totalCableArea);

    const resArea = document.getElementById('resultArea');
    resArea.classList.remove('hidden');

    if (possibleOptions.length === 0) {
        document.getElementById('recSize').innerText = "ไม่มีขนาดที่รองรับ";
        document.getElementById('recPrice').innerText = "-";
        document.getElementById('comparisonList').innerHTML = "";
        return;
    }

    const best = possibleOptions[0];

    document.getElementById('recSize').innerText =
        (installType === 'conduit' ? "ท่อ " : "ราง ") + best.name;

    document.getElementById('recPrice').innerText =
        "฿" + best.price.toLocaleString();

    renderComparison(possibleOptions, totalCableArea, limitField);
}

function renderComparison(options, cableArea, limitField) {
    const list = document.getElementById('comparisonList');
    list.innerHTML = '';

    options.forEach((item, index) => {

        const fillRate = ((cableArea / item[limitField]) * 100).toFixed(1);

        const div = document.createElement('div');
        div.className =
            `p-4 flex items-center justify-between transition-all 
            ${index === 0 ? 'selected-size-card' : ''}`;

        div.innerHTML = `
            <div class="flex flex-col">
                <span class="text-sm font-bold">${item.name}</span>
                <span class="text-xs text-gray-500">
                    ใช้งาน ${fillRate}% ของพื้นที่
                </span>
            </div>
            <div class="text-right">
                <p class="font-bold text-pink-600">
                    ฿${item.price.toLocaleString()}
                </p>
                ${index > 0 ? 
                    `<p class="text-xs text-gray-400">
                        แพงกว่า ฿${(item.price - options[0].price).toLocaleString()}
                    </p>` : 
                    `<p class="text-xs text-green-500">ประหยัดที่สุด</p>`
                }
            </div>
        `;

        list.appendChild(div);
    });
}
</script>